<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tests Local - API CIP FARO</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #2c3e50;
        text-align: center;
        margin-bottom: 30px;
      }
      h2 {
        color: #34495e;
        border-bottom: 2px solid #e74c3c;
        padding-bottom: 10px;
        margin-top: 40px;
      }
      .test-section {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #f9f9f9;
      }
      .form-group {
        margin: 15px 0;
      }
      label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
        color: #2c3e50;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
      }
      textarea {
        height: 100px;
        resize: vertical;
      }
      button {
        background: #e74c3c;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-right: 10px;
        margin-top: 10px;
      }
      button:hover {
        background: #c0392b;
      }
      button.secondary {
        background: #3498db;
      }
      button.secondary:hover {
        background: #2980b9;
      }
      .result {
        margin: 20px 0;
        padding: 15px;
        border-radius: 5px;
        font-family: monospace;
        white-space: pre-wrap;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 10px;
      }
      .status-online {
        background-color: #27ae60;
      }
      .status-offline {
        background-color: #e74c3c;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px 0;
      }
      .offre-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background: white;
      }
      .offre-card h4 {
        color: #e74c3c;
        margin: 0 0 10px 0;
      }
      .offre-card .meta {
        color: #666;
        font-size: 0.9em;
        margin: 5px 0;
      }
      @media (max-width: 768px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üß™ Tests Local - API CIP FARO</h1>

      <!-- Status de l'API -->
      <div class="test-section">
        <h2>üìä Status de l'API</h2>
        <div id="api-status">
          <span class="status-indicator status-offline"></span>
          <span>V√©rification en cours...</span>
        </div>
        <button onclick="checkApiHealth()">üîç V√©rifier Sant√© API</button>
        <div id="health-result" class="result" style="display: none"></div>
      </div>

      <!-- Test Authentification -->
      <div class="test-section">
        <h2>üîê Test Authentification</h2>
        <div class="form-group">
          <label>Nom d'utilisateur:</label>
          <input
            type="text"
            id="username"
            value="cipfaro"
            placeholder="cipfaro"
          />
        </div>
        <div class="form-group">
          <label>Mot de passe:</label>
          <input
            type="password"
            id="password"
            value="admin123"
            placeholder="admin123"
          />
        </div>
        <button onclick="testAuth()">üîë G√©n√©rer Token</button>
        <div id="auth-result" class="result" style="display: none"></div>
      </div>

      <!-- Test D√©p√¥t d'Offre -->
      <div class="test-section">
        <h2>üíº Test D√©p√¥t d'Offre d'Emploi</h2>
        <div class="form-group">
          <label>Entreprise:</label>
          <input
            type="text"
            id="entreprise"
            value="Test Corp"
            placeholder="Nom de l'entreprise"
          />
        </div>
        <div class="form-group">
          <label>Titre du poste:</label>
          <input
            type="text"
            id="titre"
            value="D√©veloppeur Test"
            placeholder="Titre du poste"
          />
        </div>
        <div class="form-group">
          <label>Type de contrat:</label>
          <select id="type">
            <option value="CDI">CDI</option>
            <option value="CDD">CDD</option>
            <option value="Freelance">Freelance</option>
            <option value="Stage">Stage</option>
          </select>
        </div>
        <div class="form-group">
          <label>Description:</label>
          <textarea id="description" placeholder="Description du poste">
Test d'int√©gration pour v√©rifier le bon fonctionnement de l'API de d√©p√¥t d'offres d'emploi.</textarea
          >
        </div>
        <div class="form-group">
          <label>Email de contact:</label>
          <input
            type="email"
            id="emailContact"
            value="test@testcorp.com"
            placeholder="contact@entreprise.fr"
          />
        </div>
        <button onclick="submitOffre()">üìù D√©poser l'Offre</button>
        <div id="offre-result" class="result" style="display: none"></div>
      </div>

      <!-- Test Candidature -->
      <div class="test-section">
        <h2>üë§ Test Candidature</h2>
        <div class="form-group">
          <label>Nom:</label>
          <input type="text" id="nom" value="Dupont" placeholder="Nom" />
        </div>
        <div class="form-group">
          <label>Pr√©nom:</label>
          <input type="text" id="prenom" value="Jean" placeholder="Pr√©nom" />
        </div>
        <div class="form-group">
          <label>Email:</label>
          <input
            type="email"
            id="email"
            value="jean.dupont@test.com"
            placeholder="email@exemple.fr"
          />
        </div>
        <div class="form-group">
          <label>Domaine:</label>
          <select id="domaine">
            <option value="D√©veloppement">D√©veloppement</option>
            <option value="Design">Design</option>
            <option value="Marketing">Marketing</option>
            <option value="Commercial">Commercial</option>
            <option value="RH">RH</option>
            <option value="Autre">Autre</option>
          </select>
        </div>
        <div class="form-group">
          <label>Message:</label>
          <textarea id="message" placeholder="Votre message">
Je suis int√©ress√© par les opportunit√©s dans votre entreprise. Ceci est un message de test pour valider le syst√®me de candidatures.</textarea
          >
        </div>
        <button onclick="submitCandidature()">üì® Envoyer Candidature</button>
        <div id="candidature-result" class="result" style="display: none"></div>
      </div>

      <!-- Liste des Offres -->
      <div class="test-section">
        <h2>üìã Offres d'Emploi Actuelles</h2>
        <button onclick="loadOffres()">üîÑ Charger les Offres</button>
        <button onclick="resetDatabase()" class="secondary">
          üóëÔ∏è R√©initialiser BDD
        </button>
        <div id="offres-container"></div>
      </div>

      <!-- Liste des Candidatures -->
      <div class="test-section">
        <h2>üìÑ Candidatures Re√ßues</h2>
        <button onclick="loadCandidatures()">
          üîÑ Charger les Candidatures
        </button>
        <div id="candidatures-container"></div>
      </div>
    </div>

    <script>
      const API_BASE = 'http://localhost:5000/api';

      // V√©rification automatique au chargement
      window.onload = function() {
          checkApiHealth();
          loadOffres();
      };

      async function checkApiHealth() {
          try {
              const response = await fetch(`${API_BASE}/health`);
              const data = await response.json();

              const statusElement = document.getElementById('api-status');
              const resultElement = document.getElementById('health-result');

              if (response.ok) {
                  statusElement.innerHTML = '<span class="status-indicator status-online"></span>API en ligne - ' + data.environment;
                  resultElement.className = 'result success';
                  resultElement.textContent = JSON.stringify(data, null, 2);
              } else {
                  throw new Error('API non disponible');
              }

              resultElement.style.display = 'block';
          } catch (error) {
              const statusElement = document.getElementById('api-status');
              const resultElement = document.getElementById('health-result');

              statusElement.innerHTML = '<span class="status-indicator status-offline"></span>API hors ligne';
              resultElement.className = 'result error';
              resultElement.textContent = 'Erreur: ' + error.message;
              resultElement.style.display = 'block';
          }
      }

      async function testAuth() {
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;
          const resultElement = document.getElementById('auth-result');

          try {
              const response = await fetch(`${API_BASE}/auth/token`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({ username, password })
              });

              const data = await response.json();

              if (response.ok) {
                  resultElement.className = 'result success';
                  resultElement.textContent = 'Token g√©n√©r√© avec succ√®s:\\n' + JSON.stringify(data, null, 2);
              } else {
                  resultElement.className = 'result error';
                  resultElement.textContent = 'Erreur: ' + data.error;
              }

              resultElement.style.display = 'block';
          } catch (error) {
              resultElement.className = 'result error';
              resultElement.textContent = 'Erreur de connexion: ' + error.message;
              resultElement.style.display = 'block';
          }
      }

      async function submitOffre() {
          const entreprise = document.getElementById('entreprise').value;
          const titre = document.getElementById('titre').value;
          const type = document.getElementById('type').value;
          const description = document.getElementById('description').value;
          const emailContact = document.getElementById('emailContact').value;
          const resultElement = document.getElementById('offre-result');

          try {
              const response = await fetch(`${API_BASE}/offre`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      entreprise,
                      titre,
                      type,
                      description,
                      emailContact
                  })
              });

              const data = await response.json();

              if (response.ok) {
                  resultElement.className = 'result success';
                  resultElement.textContent = 'Offre d√©pos√©e avec succ√®s:\\n' + JSON.stringify(data, null, 2);
                  // Recharger les offres
                  setTimeout(loadOffres, 1000);
              } else {
                  resultElement.className = 'result error';
                  resultElement.textContent = 'Erreur: ' + data.error;
              }

              resultElement.style.display = 'block';
          } catch (error) {
              resultElement.className = 'result error';
              resultElement.textContent = 'Erreur de connexion: ' + error.message;
              resultElement.style.display = 'block';
          }
      }

      async function submitCandidature() {
          const nom = document.getElementById('nom').value;
          const prenom = document.getElementById('prenom').value;
          const email = document.getElementById('email').value;
          const domaine = document.getElementById('domaine').value;
          const message = document.getElementById('message').value;
          const resultElement = document.getElementById('candidature-result');

          try {
              const response = await fetch(`${API_BASE}/candidature`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      nom,
                      prenom,
                      email,
                      domaine,
                      message
                  })
              });

              const data = await response.json();

              if (response.ok) {
                  resultElement.className = 'result success';
                  resultElement.textContent = 'Candidature envoy√©e avec succ√®s:\\n' + JSON.stringify(data, null, 2);
                  // Recharger les candidatures
                  setTimeout(loadCandidatures, 1000);
              } else {
                  resultElement.className = 'result error';
                  resultElement.textContent = 'Erreur: ' + data.error;
              }

              resultElement.style.display = 'block';
          } catch (error) {
              resultElement.className = 'result error';
              resultElement.textContent = 'Erreur de connexion: ' + error.message;
              resultElement.style.display = 'block';
          }
      }

      async function loadOffres() {
          const container = document.getElementById('offres-container');

          try {
              const response = await fetch(`${API_BASE}/offres`);
              const offres = await response.json();

              if (response.ok) {
                  if (offres.length === 0) {
                      container.innerHTML = '<div class="result info">Aucune offre d\\'emploi trouv√©e.</div>';
                  } else {
                      let html = `<div class="result success">‚úÖ ${offres.length} offre(s) charg√©e(s)</div><div class="grid">`;

                      offres.forEach(offre => {
                          html += `
                              <div class="offre-card">
                                  <h4>${offre.titre}</h4>
                                  <div class="meta"><strong>Entreprise:</strong> ${offre.entreprise}</div>
                                  <div class="meta"><strong>Type:</strong> ${offre.type}</div>
                                  <div class="meta"><strong>Contact:</strong> ${offre.emailContact}</div>
                                  <div class="meta"><strong>Publi√© le:</strong> ${new Date(offre.datePublication).toLocaleDateString()}</div>
                                  <p>${offre.description}</p>
                              </div>
                          `;
                      });

                      html += '</div>';
                      container.innerHTML = html;
                  }
              } else {
                  container.innerHTML = '<div class="result error">Erreur lors du chargement des offres</div>';
              }
          } catch (error) {
              container.innerHTML = '<div class="result error">Erreur de connexion: ' + error.message + '</div>';
          }
      }

      async function loadCandidatures() {
          const container = document.getElementById('candidatures-container');

          try {
              const response = await fetch(`${API_BASE}/candidatures`);
              const candidatures = await response.json();

              if (response.ok) {
                  if (candidatures.length === 0) {
                      container.innerHTML = '<div class="result info">Aucune candidature trouv√©e.</div>';
                  } else {
                      let html = `<div class="result success">‚úÖ ${candidatures.length} candidature(s) trouv√©e(s)</div><div class="grid">`;

                      candidatures.forEach(candidature => {
                          html += `
                              <div class="offre-card">
                                  <h4>${candidature.prenom} ${candidature.nom}</h4>
                                  <div class="meta"><strong>Email:</strong> ${candidature.email}</div>
                                  <div class="meta"><strong>Domaine:</strong> ${candidature.domaine}</div>
                                  <div class="meta"><strong>Re√ßue le:</strong> ${new Date(candidature.dateCreation).toLocaleDateString()}</div>
                                  <p>${candidature.message}</p>
                              </div>
                          `;
                      });

                      html += '</div>';
                      container.innerHTML = html;
                  }
              } else {
                  container.innerHTML = '<div class="result error">Erreur lors du chargement des candidatures</div>';
              }
          } catch (error) {
              container.innerHTML = '<div class="result error">Erreur de connexion: ' + error.message + '</div>';
          }
      }

      async function resetDatabase() {
          if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser la base de donn√©es ?')) {
              try {
                  const response = await fetch(`${API_BASE}/dev/reset-database`, {
                      method: 'POST',
                  });

                  const data = await response.json();

                  if (response.ok) {
                      alert('Base de donn√©es r√©initialis√©e avec succ√®s !');
                      loadOffres();
                      loadCandidatures();
                  } else {
                      alert('Erreur: ' + data.error);
                  }
              } catch (error) {
                  alert('Erreur de connexion: ' + error.message);
              }
          }
      }
    </script>
  </body>
</html>
